<!DOCTYPE html>
<html>
  <head>
    <title>Stream Schedule Panel</title>
  </head>
  <body>
    <script src="https://extension-files.twitch.tv/helper/v1/twitch-ext.min.js"></script>

    <main>
      <h1>My Stream Schedule</h1>
      <p id="loading">Loading...</p>
      <ol id="events"></ol>
      <pre id="res"></pre>
    </main>

    <template id="event-details">
      <li>
        <details>
          <summary>
            <h2></h2>
            <time></time>
          </summary>
          <div class="description"></div>
        </details>
      </li>
    </template>

    <script>
      fetch(
        "http://localhost:8080?ical=https://calendar.google.com/calendar/ical/11quhcpcke61s9r7cah9htaafo%40group.calendar.google.com/public/basic.ics"
      )
        .then((res) => res.json())
        .then((res) => {
          const events = Object.values(res);

          const eventList = events.map((event) => {
            return {
              id: event.uid,
              title: event.summary,
              date: new Date(event.start),
              description: event.description,
            };
          });

          if ("content" in document.createElement("template")) {
            const list = document.querySelector("#events");
            const template = document.querySelector("#event-details");

            eventList.forEach((event) => {
              const el = template.content.cloneNode(true);
              const title = el.querySelector("h2");
              const time = el.querySelector("time");
              const description = el.querySelector(".description");

              title.innerText = event.title;
              time.innerText = event.date.toLocaleDateString("en-US");
              time.setAttribute("datetime", event.date.toISOString());
              description.innerText = event.description;
              list.appendChild(el);
            });

            document.getElementById("loading").remove();
          }

          document.getElementById("res").innerText = JSON.stringify(
            eventList,
            null,
            2
          );
          // let eventsLog = JSON.stringify(eventList, null, 2);
          // window.Twitch.ext.rig.log(eventsLog);
        });
    </script>
  </body>
</html>
